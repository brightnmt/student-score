<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéì ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏Å‡πÇ‡∏Å‡∏Ñ‡∏¥‡∏î‡∏™‡πå ‡∏™‡∏á‡∏Ç‡∏•‡∏≤</title>

<style>
body{
  font-family:"Sarabun",sans-serif;
  margin:0;
  padding:20px;
  background:linear-gradient(135deg,#4caf50,#e91e63);
  background-size:400% 400%;
  animation:bgMove 12s ease infinite;
}
@keyframes bgMove{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

h2{text-align:center;color:white;}
.status{text-align:center;color:white;margin:10px;}

.search-container{max-width:500px;margin:20px auto;position:relative;}
.search-input{
  width:100%;
  padding:14px 18px 14px 45px;
  border-radius:15px;
  border:none;
  font-size:16px;
  box-shadow:0 8px 25px rgba(0,0,0,.3);
}
.search-icon{
  position:absolute;
  left:15px;
  top:50%;
  transform:translateY(-50%);
}
.search-dropdown{
  width:100%;
  background:white;
  border-radius:15px;
  box-shadow:0 15px 35px rgba(0,0,0,.25);
  margin-top:10px;
  max-height:0;
  overflow:hidden;
  opacity:0;
  transform:translateY(-10px);
  transition:all .35s ease;
}
.search-dropdown.show{
  max-height:300px;
  opacity:1;
  transform:translateY(0);
  overflow:auto;
}
.search-item{
  padding:14px;
  cursor:pointer;
  transition:.2s;
}
.search-item:hover{
  background:linear-gradient(90deg,#4caf50,#e91e63);
  color:white;
}

#studentName{
  text-align:center;
  font-size:24px;
  font-weight:bold;
  color:white;
  margin-top:25px;
  margin-bottom:10px;
}

/* Summary */
.summary-container{
  display:none;
  justify-content:center;
  gap:20px;
  flex-wrap:wrap;
  margin:25px 0;
}
.summary-card{
  backdrop-filter:blur(10px);
  background:rgba(255,255,255,.2);
  border-radius:20px;
  padding:20px;
  width:220px;
  text-align:center;
  color:white;
  box-shadow:0 8px 30px rgba(0,0,0,.3);
}
.summary-card .value{
  font-size:26px;
  font-weight:bold;
  margin-top:10px;
}

/* Progress */
.progress-section{
  display:none;
  margin-bottom:30px;
  text-align:center;
}
.progress-bar{
  height:45px;
  max-width:750px;
  margin:auto;
  background:rgba(255,255,255,.3);
  border-radius:50px;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  width:0%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-weight:600;
  font-size:14px;
  letter-spacing:.3px;
  border-radius:50px;
  transition:width .8s ease;
  position:relative;
  overflow:hidden;
  padding:0 20px;           /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡∏≤‡∏¢‡πÉ‡∏à */
  text-align:center;
  white-space:nowrap;       /* ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
  text-shadow:0 1px 3px rgba(0,0,0,.4); /* ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
}

/* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡πÅ‡∏™‡∏á */
.progress-fill::after{
  content:"";
  position:absolute;
  top:0;
  left:-40%;
  width:30%;
  height:100%;
  background:linear-gradient(120deg,
    rgba(255,255,255,0.15) 0%,
    rgba(255,255,255,0.4) 50%,
    rgba(255,255,255,0.15) 100%);
  animation:shine 4s infinite;
}
@keyframes shine{
  0%{left:-40%;}
  100%{left:120%;}
}

/* Subject Buttons */
.subject-buttons{
  display:flex;
  justify-content:center;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:20px;
}
.subject-btn{
  padding:10px 18px;
  border-radius:25px;
  border:none;
  cursor:pointer;
  background:white;
  font-weight:bold;
  box-shadow:0 4px 15px rgba(0,0,0,.2);
}
.subject-btn.active{
  background:#2e7d32;
  color:white;
}

/* Rank Button */
.rank-toggle{
  display:block;
  margin:20px auto;
  padding:12px 28px;
  border-radius:30px;
  border:none;
  cursor:pointer;
  background:white;
  color:#e91e63;
  font-weight:bold;
  font-size:15px;
  letter-spacing:.5px;
  transition:all .3s ease;
  box-shadow:0 8px 20px rgba(0,0,0,.3);
}

/* ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß */
.rank-toggle.active{
  background:linear-gradient(135deg,#ad1457,#e91e63,#ff4081);
  background-size:200% 200%;
  animation:pinkGlow 4s ease infinite;
  color:white;
}

@keyframes pinkGlow{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

.rank-section{display:none;margin-top:10px;}
.medal{font-size:22px;}

table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
  margin-bottom:15px;
}
th{background:#2e7d32;color:white;padding:14px;}
td{padding:14px;text-align:center;}
.total-row{background:#e91e63;color:white;font-weight:bold;}
.highlight{background:#028ad4 !important;color:white;font-weight:bold;}

.grade-A{background:#1b5e20;color:#fff;}
.grade-B{background:#1565c0;color:#fff;}
.grade-C{background:#ef6c00;color:#fff;}
.grade-D{background:#f9a825;color:#fff;}
.grade-F{background:#c62828;color:#fff;}

/* üéì Grade Detail Box */
.grade-detail-box{
  margin-top:25px;
  padding:25px;
  border-radius:20px;
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(12px);
  color:white;
  box-shadow:0 8px 30px rgba(0,0,0,.3);
  animation:fadeIn .5s ease;
}
.grade-detail-box h3{
  text-align:center;
  margin-bottom:15px;
}
.grade-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
  gap:15px;
}
.grade-item{
  padding:15px;
  border-radius:15px;
  text-align:center;
  font-weight:bold;
  box-shadow:0 4px 15px rgba(0,0,0,.25);
}
.grade-A-box{background:#1b5e20;}
.grade-B-box{background:#1565c0;}
.grade-C-box{background:#ef6c00;}
.grade-D-box{background:#f9a825;color:#000;}
.grade-F-box{background:#c62828;}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}
</style>
</head>

<body>

<h2>üéì ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏Å‡πÇ‡∏Å‡∏Ñ‡∏¥‡∏î‡∏™‡πå ‡∏™‡∏á‡∏Ç‡∏•‡∏≤</h2>
<div class="status" id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>

<div class="search-container">
  <span class="search-icon">üîç</span>
  <input type="text" id="studentSearch"
         class="search-input"
         placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." disabled>
  <div class="search-dropdown" id="searchDropdown"></div>
</div>

<div id="studentName"></div>
<div class="summary-container" id="summaryContainer"></div>

<div class="progress-section" id="progressSection">
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<div class="subject-buttons" id="subjectButtons"></div>
<div id="content"></div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbwAVWIBh8xoGwFwYd6raV5igaQOPwS-3I3CBe1itNuofaSbUR95UsCm2e27ShuAmhssWQ/exec";
let allData={}, currentStudent=null, currentId=null;

fetch(API_URL)
.then(r=>r.json())
.then(data=>{
  allData=data;
  document.getElementById("statusText").textContent="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤";
  document.getElementById("studentSearch").disabled=false;
});

function grade(p){
  if(p>=80)return"A";
  if(p>=70)return"B";
  if(p>=60)return"C";
  if(p>=50)return"D";
  return"F";
}
function getColor(g){
  return {A:"#1b5e20",B:"#1565c0",C:"#ef6c00",D:"#f9a825",F:"#c62828"}[g];
}
function getRankDisplay(rank){
  if(rank===1)return'<span class="medal">ü•á</span>';
  if(rank===2)return'<span class="medal">ü•à</span>';
  if(rank===3)return'<span class="medal">ü•â</span>';
  return rank;
}

const searchInput=document.getElementById("studentSearch");
const dropdown=document.getElementById("searchDropdown");

searchInput.addEventListener("input",function(){
  const keyword=this.value.toLowerCase();
  dropdown.innerHTML="";
  if(!keyword){dropdown.classList.remove("show");return;}
  Object.entries(allData).forEach(([id,s])=>{
    if(id.includes(keyword)||s.name.toLowerCase().includes(keyword)){
      const div=document.createElement("div");
      div.className="search-item";
      div.textContent=id+" - "+s.name;
      div.onclick=()=>{showStudent(id);dropdown.classList.remove("show");};
      dropdown.appendChild(div);
    }
  });
  dropdown.classList.toggle("show", dropdown.innerHTML!=="");
});

document.addEventListener("click",function(e){
  if(!document.querySelector(".search-container").contains(e.target)){
    dropdown.classList.remove("show");
  }
});

function showStudent(id){
  currentId=id;
  currentStudent=allData[id];
  document.getElementById("studentName").textContent=
    currentStudent.name+" ("+currentStudent.class+")";
  renderSubjects();
}

function renderSubjects(){
  const box=document.getElementById("subjectButtons");
  box.innerHTML="";
  document.getElementById("content").innerHTML="";
  document.getElementById("summaryContainer").style.display="none";
  document.getElementById("progressSection").style.display="none";

  for(const subject in currentStudent.subjects){
    const btn=document.createElement("button");
    btn.className="subject-btn";
    btn.textContent=subject;
    btn.onclick=()=>{
      document.querySelectorAll(".subject-btn")
      .forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      renderSubject(subject);
    };
    box.appendChild(btn);
  }
}

function renderSubject(subject){

  let total=0,full=0;
  currentStudent.subjects[subject].forEach(i=>{
    total+=Number(i.score);
    full+=Number(i.full);
  });

  const percent=Math.round((total/full)*100);
  const g=grade(percent);

  document.getElementById("summaryContainer").style.display="flex";
  document.getElementById("summaryContainer").innerHTML=`
    <div class="summary-card">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°<div class="value">${total}</div></div>
    <div class="summary-card">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå<div class="value">${percent}%</div></div>
    <div class="summary-card">‡πÄ‡∏Å‡∏£‡∏î<div class="value">${g}</div></div>
  `;

  document.getElementById("progressSection").style.display="block";
  const fill=document.getElementById("progressFill");
  fill.style.width="0%";
  fill.style.background=getColor(g);
  setTimeout(()=>{
    fill.style.width=percent+"%";
    fill.textContent=`‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ ${subject} : ${percent}% (‡πÄ‡∏Å‡∏£‡∏î ${g})`;
  },100);

  let html=`<table>
  <tr><th>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</th><th>‡πÄ‡∏Å‡∏£‡∏î</th></tr>`;

  currentStudent.subjects[subject].forEach(i=>{
    const p=(i.score/i.full)*100;
    const g2=grade(p);
    html+=`
    <tr>
      <td>${i.chapter}</td>
      <td>${i.score}</td>
      <td>${i.full}</td>
      <td class="grade-${g2}">${g2}</td>
    </tr>`;
  });

  html+=`
  <tr class="total-row">
    <td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏¥‡∏ä‡∏≤</td>
    <td>${total}</td>
    <td>${full}</td>
    <td>${g}</td>
  </tr>
  </table>

  <button class="rank-toggle" onclick="toggleRank('${subject}')">
    üèÜ ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ
  </button>
  <div class="rank-section" id="rankSection"></div>

  <div class="grade-detail-box">
  <h3>üìò ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÄ‡∏Å‡∏£‡∏î (‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå)</h3>
  <div class="grade-grid">
    <div class="grade-item grade-A-box">A<br>80% ‚Äì 100%</div>
    <div class="grade-item grade-B-box">B<br>70% ‚Äì 79%</div>
    <div class="grade-item grade-C-box">C<br>60% ‚Äì 69%</div>
    <div class="grade-item grade-D-box">D<br>50% ‚Äì 59%</div>
    <div class="grade-item grade-F-box">F<br>‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 50%</div>
  </div>
</div>
  `;

  document.getElementById("content").innerHTML=html;
}

function toggleRank(subject){
  const box=document.getElementById("rankSection");
  const btn=document.querySelector(".rank-toggle");

  if(box.style.display==="block"){
    box.style.display="none";
    box.innerHTML="";
    btn.classList.remove("active"); // ‡πÄ‡∏≠‡∏≤ active ‡∏≠‡∏≠‡∏Å
    return;
  }

  btn.classList.add("active"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° active ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î

  let ranking=[];
  Object.entries(allData).forEach(([id,s])=>{
    if(s.class===currentStudent.class && s.subjects[subject]){
      let total=0;
      s.subjects[subject].forEach(i=>total+=Number(i.score));
      ranking.push({id,name:s.name,total});
    }
  });

  ranking.sort((a,b)=>b.total-a.total);

let rank = 0;
let lastScore = null;

ranking.forEach((r)=>{
  if(r.total !== lastScore){
    rank++;   // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞ 1 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  }
  r.rank = rank;
  lastScore = r.total;
});


  let html=`<table>
  <tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th></tr>`;

  ranking.forEach(r=>{
    html+=`
    <tr class="${r.id===currentId?'highlight':''}">
      <td>${getRankDisplay(r.rank)}</td>
      <td>${r.id}</td>
      <td>${r.name}</td>
      <td>${r.total}</td>
    </tr>`;
  });

  html+="</table>";

  box.innerHTML=html;
  box.style.display="block";
}

</script>
</body>
</html>


